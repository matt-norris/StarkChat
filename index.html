<!DOCTYPE html>
<html lang="en-US">
<head>
        <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stark Chat by Matthew Norris</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
      <style>
       body {
            height: 100vh;
            background-color: #202020;
        }
        .chat-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: calc(100vh - 56px);  /* Subtract the height of the navbar */
        }
        .card {
            background-color: #303030;
            color: #fbca03;
            border-color: #fbca03;
        }
        .btn-primary {
            background-color: #fbca03;
            border-color: #fbca03;
            color: #303030;
        }
        .btn-secondary {
            background-color: #aa0505;
            border-color: #aa0505;
            color: #fbca03;
        }
        .form-control {
            background-color: #404040;
            color: #fbca03;
            border-color: #fbca03;
        }
    </style>


    <script>
        let mediaRecorder;
        let chunks = [];

        function downloadAudio(blob) {
            // Create an object URL for the blob
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            // the filename you want
            a.download = 'test.mp3';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        }

        async function sendAudio(blob) {
            // Download the audio before sending it
            downloadAudio(blob);

            const formData = new FormData();
            formData.append('audio', blob, 'audio.mp3');

            const response = await fetch('http://localhost:5300/transcribe', {
                method: 'POST',
                body: formData
            });

            const data = await response.text();
            console.log(data);
            const questionInput = document.getElementById('questionInput');
            questionInput.value = data;
        }

        async function toggleRecording() {
            const recordButton = document.getElementById('recordButton');

            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                recordButton.textContent = "Start Recording";
            } else {
                chunks = [];
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = event => chunks.push(event.data);
                mediaRecorder.onstop = () => {
                    // When recording stops, construct a Blob from the recorded audio chunks
                    const blob = new Blob(chunks, { type: 'audio/mp3' });
                    sendAudio(blob);
                };
                mediaRecorder.start();
                recordButton.textContent = "Stop Recording";
            }
        }

 async function submitQuestion() {
    const questionInput = document.getElementById('questionInput');
    const question = questionInput.value;

    if (!question) {
        alert('Please enter a question');
        return;
    }

    const responseDiv = document.getElementById('response');

    // Send the question to your Python script and get the response
    const url = 'http://localhost:5300/ask_question';  // Change this URL to the appropriate endpoint in your Python script
    const requestOptions = {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: question })
    };

    const response = await fetch(url, requestOptions);
    const data = await response.json();
    console.log(data)

    // Display the response on the page
    responseDiv.innerHTML = `Answer: ${data.answer}`;

    // Handle the base64 encoded audio string
    if (data.audio) {
        const audioData = atob(data.audio).split('').map(c => c.charCodeAt(0));
        const audioBytes = new Uint8Array(audioData);
        const blob = new Blob([audioBytes], {type: 'audio/mpeg'});
        const audioUrl = URL.createObjectURL(blob);

        // Create a new audio element and play it
        const audio = new Audio(audioUrl);
        audio.play();
    }
}


    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Stark Chat</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Features</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Pricing</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="chat-container ">
        <div class="card bg-dark">
            <div class="card-header">
                Stark Chat
            </div>
            <div class="card-body">
                <div class="input-group mb-3">
                    <input type="text" id="questionInput" class="form-control" placeholder="Enter your question" aria-label="Question input">
                    <button id="submitQuestion" class="btn btn-primary" onclick="submitQuestion()">Submit</button>
                </div>
                <div id="response" class="mb-3"></div>
                <button id="recordButton" class="btn btn-secondary" onclick="toggleRecording()">Start Recording</button>
            </div>
        </div>
    </div>
</body>
</html>
