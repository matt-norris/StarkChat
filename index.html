<!DOCTYPE html>
<html lang="en-US">
<head>
    <title>Audio Recorder</title>
    <script>
        let mediaRecorder;
        let chunks = [];

        function downloadAudio(blob) {
            // Create an object URL for the blob
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            // the filename you want
            a.download = 'test.mp3';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        }

        async function sendAudio(blob) {
            // Download the audio before sending it
            downloadAudio(blob);

            const formData = new FormData();
            formData.append('audio', blob, 'audio.mp3');

            const response = await fetch('http://localhost:5300/transcribe', {
                method: 'POST',
                body: formData
            });

            const data = await response.text();
            console.log(data);
            const questionInput = document.getElementById('questionInput');
            questionInput.value = data;
        }

        async function toggleRecording() {
            const recordButton = document.getElementById('recordButton');

            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                recordButton.textContent = "Start Recording";
            } else {
                chunks = [];
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = event => chunks.push(event.data);
                mediaRecorder.onstop = () => {
                    // When recording stops, construct a Blob from the recorded audio chunks
                    const blob = new Blob(chunks, { type: 'audio/mp3' });
                    sendAudio(blob);
                };
                mediaRecorder.start();
                recordButton.textContent = "Stop Recording";
            }
        }

 async function submitQuestion() {
    const questionInput = document.getElementById('questionInput');
    const question = questionInput.value;

    if (!question) {
        alert('Please enter a question');
        return;
    }

    const responseDiv = document.getElementById('response');

    // Send the question to your Python script and get the response
    const url = 'http://localhost:5300/ask_question';  // Change this URL to the appropriate endpoint in your Python script
    const requestOptions = {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: question })
    };

    const response = await fetch(url, requestOptions);
    const data = await response.json();
    console.log(data)

    // Display the response on the page
    responseDiv.innerHTML = `Answer: ${data.answer}`;

    // Handle the base64 encoded audio string
    if (data.audio) {
        const audioData = atob(data.audio).split('').map(c => c.charCodeAt(0));
        const audioBytes = new Uint8Array(audioData);
        const blob = new Blob([audioBytes], {type: 'audio/mpeg'});
        const audioUrl = URL.createObjectURL(blob);

        // Create a new audio element and play it
        const audio = new Audio(audioUrl);
        audio.play();
    }
}


    </script>
</head>
<body>
<label for="questionInput"></label><input type="text" id="questionInput" placeholder="Enter your question">
    <button id="submitQuestion" onclick="submitQuestion()">Submit Question</button>
    <div id="response"></div>

    <button id="recordButton" onclick="toggleRecording()">Start Recording</button>
</body>
</html>
